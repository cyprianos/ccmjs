#! /usr/bin/env node

var ccm = require('../ccm.js');
var fs = require('fs');
var util = require('util');
var glob = require('glob');
var minimatch = require('minimatch');
var argv = require('optimist')
            .default('files', './**/*.js')
            .default('encoding', 'utf8')
            .default('results', '25')
            .argv;

            
var topResult = ccm.createResult(parseInt(argv.results));
glob(argv.files, function(err, files) {

  files.forEach(function(file) {
	if(argv.exclude && minimatch(file, argv.exclude)) {
		return;
	};

    try {
      var fileContent = fs.readFileSync(file, { encoding: argv.encoding });
      var res = ccm.calculate( fileContent );
      topResult.addResults(file, res);
    } catch(err) {
      console.log(util.inspect(err));
    }
  });

    ccm.formatResult(topResult).forEach(function(res) {
      console.log(res);
    });
});


